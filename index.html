<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kitchen Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eefbf5', 100: '#d6f5e6', 200: '#b0ead1', 300: '#7cd9b6', 400: '#48c196', 500: '#25a67a', 600: '#178762', 700: '#136c51', 800: '#125642', 900: '#104737', 950: '#07281f' }
                    }
                }
            }
        }
    </script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background-color: #f0f2f5 !important; color: #1a1a2e !important; font-family: 'Inter', sans-serif; }

        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 0, 'opsz' 24; }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 99px; }

        /* Page transitions */
        .page { display: none; opacity: 0; transition: opacity 0.25s ease; }
        .page.active { display: flex; flex-direction: column; opacity: 1; }

        /* Bottom nav */
        .nav-item { transition: all 0.2s ease; }
        .nav-item.active .nav-icon { color: #25a67a; }
        .nav-item.active .nav-label { color: #25a67a; font-weight: 700; }
        .nav-item.active .nav-dot { opacity: 1; }

        /* Cards */
        .card { background: white; border-radius: 1rem; border: 1px solid #e5e7eb; transition: all 0.15s ease; }
        .card:active { transform: scale(0.98); }
        .card-selected { background: #1a1a2e !important; color: white !important; border-color: #25a67a !important; box-shadow: 0 0 0 2px #25a67a; }

        /* Toggle */
        .seg-ctrl { background: #f0f2f5; padding: 3px; border-radius: 12px; display: inline-flex; gap: 2px; }
        .seg-btn { padding: 8px 16px; border-radius: 10px; font-size: 11px; font-weight: 700; text-transform: uppercase; transition: all 0.2s ease; letter-spacing: 0.04em; color: #94a3b8; cursor: pointer; }
        .seg-btn.active { background: white; color: #1a1a2e; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

        /* Floating action button */
        .fab { width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(37,166,122,0.35); transition: all 0.15s ease; }
        .fab:active { transform: scale(0.9); }

        /* Slide-up sheet */
        .sheet-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 100; }
        .sheet-overlay.open { display: flex; justify-content: center; align-items: flex-end; }
        @media (min-width: 640px) { .sheet-overlay.open { align-items: center; } }
        .sheet { background: white; width: 100%; max-width: 520px; max-height: 90vh; border-radius: 1.5rem 1.5rem 0 0; padding: 0; animation: sheetUp 0.3s cubic-bezier(0.32, 0.72, 0, 1); overflow-y: auto; }
        @media (min-width: 640px) { .sheet { border-radius: 1.5rem; max-height: 85vh; } }
        @keyframes sheetUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Checkbox custom */
        .check-item input[type="checkbox"] { accent-color: #25a67a; }

        /* Shopping item */
        .shop-item { transition: all 0.15s ease; }
        .shop-item:active { transform: scale(0.98); }
        .shop-item.checked { opacity: 0.35; }
        .shop-item.checked .item-name { text-decoration: line-through; }

        /* Store mode overrides */
        .store-mode .shop-item { padding: 1rem 1.25rem; }
        .store-mode .shop-item input[type="checkbox"] { width: 28px; height: 28px; }
        .store-mode .item-name { font-size: 1.125rem; }
        .store-mode .item-qty { font-size: 0.875rem; padding: 6px 12px; }

        /* Cooking mode */
        .cook-step { font-size: 1.25rem; line-height: 1.8; padding: 1.5rem; border-radius: 1rem; background: #f8faf9; margin-bottom: 1rem; }
        .cook-step.active-step { background: #eefbf5; border: 2px solid #25a67a; font-weight: 600; }

        /* Responsive app shell */
        @media (min-width: 1024px) {
            .app-shell { display: grid; grid-template-columns: 320px 1fr; gap: 0; max-width: 1200px; margin: 2rem auto; border-radius: 1.5rem; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; }
            .app-shell .mobile-nav { display: none; }
            .app-shell .desktop-sidebar { display: flex !important; }
            .app-shell .main-content { height: calc(100vh - 4rem); overflow-y: auto; }
            .page { display: none !important; opacity: 0; }
            .page.active { display: flex !important; opacity: 1; }
        }

        /* Pulse animation for refresh */
        @keyframes pulse-ring { 0% { transform: scale(0.9); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        .pulse-ring { animation: pulse-ring 1s ease-out infinite; }

        /* Input styles */
        .input { width: 100%; padding: 0.875rem 1rem; background: #f0f2f5; border: 2px solid transparent; border-radius: 0.875rem; font-weight: 600; font-size: 0.875rem; outline: none; transition: all 0.2s ease; }
        .input:focus { border-color: #25a67a; background: white; }
        .input::placeholder { color: #9ca3af; font-weight: 500; }

        /* Pill badge */
        .pill { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 99px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; }
    </style>
</head>
<body class="min-h-screen">

<!-- App Shell -->
<div class="app-shell bg-white min-h-screen lg:min-h-0">

    <!-- Desktop Sidebar (hidden on mobile) -->
    <div class="desktop-sidebar hidden flex-col bg-white border-r border-gray-100 h-full overflow-hidden">
        <div class="p-5 border-b border-gray-100">
            <div class="flex items-center gap-3 mb-1">
                <div class="w-9 h-9 rounded-xl bg-brand-500 flex items-center justify-center">
                    <span class="material-symbols-rounded text-white text-lg">restaurant</span>
                </div>
                <h1 class="text-lg font-black tracking-tight">Kitchen Master</h1>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto p-3">
            <button onclick="switchPage('recipes')" class="desk-nav w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-50 transition mb-1" data-page="recipes">
                <span class="material-symbols-rounded text-xl">menu_book</span> Recipes
            </button>
            <button onclick="switchPage('shopping')" class="desk-nav w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-50 transition mb-1" data-page="shopping">
                <span class="material-symbols-rounded text-xl">shopping_cart</span> Shopping List
            </button>
            <button onclick="switchPage('pantry')" class="desk-nav w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-50 transition mb-1" data-page="pantry">
                <span class="material-symbols-rounded text-xl">kitchen</span> Pantry Staples
            </button>
            <button onclick="switchPage('settings')" class="desk-nav w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-gray-500 hover:bg-gray-50 transition mb-1" data-page="settings">
                <span class="material-symbols-rounded text-xl">settings</span> Settings
            </button>
        </nav>
        <div class="p-3 border-t border-gray-100">
            <div class="text-[10px] text-gray-400 font-medium px-4 py-2">Kitchen Master v5.0</div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content flex flex-col min-h-screen lg:min-h-0 pb-20 lg:pb-0">

        <!-- ============= RECIPES PAGE ============= -->
        <div id="page-recipes" class="page active flex-1">
            <div class="sticky top-0 bg-white/95 backdrop-blur-lg z-30 border-b border-gray-100 px-4 pt-4 pb-3 lg:px-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-black tracking-tight lg:hidden">Recipes</h2>
                    <h2 class="text-xl font-black tracking-tight hidden lg:block">My Recipes</h2>
                    <button onclick="openAddRecipe()" class="flex items-center gap-1.5 bg-brand-500 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-lg shadow-brand-500/20 active:scale-95 transition">
                        <span class="material-symbols-rounded text-base">add</span> New
                    </button>
                </div>
                <input id="searchBar" onkeyup="renderRecipes()" type="text" placeholder="Search recipes..." class="input">
            </div>
            <div class="flex-1 px-4 py-4 lg:px-6 overflow-y-auto" id="recipeListContainer">
                <div id="menuList"></div>
            </div>
        </div>

        <!-- ============= SHOPPING LIST PAGE ============= -->
        <div id="page-shopping" class="page flex-1">
            <div class="sticky top-0 bg-white/95 backdrop-blur-lg z-30 border-b border-gray-100 px-4 pt-4 pb-3 lg:px-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-black tracking-tight">Shopping List</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleStoreMode()" id="storeModeBtn" class="flex items-center gap-1.5 bg-gray-900 text-white px-3.5 py-2.5 rounded-xl font-bold text-[11px] active:scale-95 transition">
                            <span class="material-symbols-rounded text-base">storefront</span> <span class="hidden sm:inline">Store</span>
                        </button>
                        <button onclick="openShopActions()" class="flex items-center justify-center w-10 h-10 bg-gray-100 rounded-xl active:scale-95 transition">
                            <span class="material-symbols-rounded text-lg">more_vert</span>
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="seg-ctrl flex-1">
                        <button onclick="setSortMode('aisle')" class="seg-btn flex-1 text-center active" id="sortAisleBtn">By Aisle</button>
                        <button onclick="setSortMode('recipe')" class="seg-btn flex-1 text-center" id="sortRecipeBtn">By Recipe</button>
                    </div>
                    <button onclick="pullFromCloud()" id="refreshBtn" class="flex items-center justify-center w-10 h-10 bg-gray-100 rounded-xl active:scale-95 transition" title="Refresh List (Pull from Cloud)">
                        <span class="material-symbols-rounded text-lg">sync</span>
                    </button>
                </div>
            </div>
            <div id="shopContent" class="flex-1 px-4 py-4 lg:px-6 overflow-y-auto">
                <div id="shoppingItems" class="max-w-2xl mx-auto"></div>
            </div>
            <!-- Finish Shopping FAB (only in store mode) -->
            <div id="finishShoppingFab" class="hidden fixed bottom-24 right-5 lg:bottom-8 lg:right-8 z-40">
                <button onclick="finishShopping()" class="fab bg-brand-500 text-white shadow-lg shadow-brand-500/30">
                    <span class="material-symbols-rounded text-2xl">check_circle</span>
                </button>
                <span class="text-[10px] font-bold text-brand-700 block text-center mt-1">Done</span>
            </div>
        </div>

        <!-- ============= PANTRY STAPLES PAGE ============= -->
        <div id="page-pantry" class="page flex-1">
            <div class="sticky top-0 bg-white/95 backdrop-blur-lg z-30 border-b border-gray-100 px-4 pt-4 pb-3 lg:px-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-black tracking-tight">Pantry Staples</h2>
                    <button onclick="openAddStaple()" class="flex items-center gap-1.5 bg-brand-500 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-lg shadow-brand-500/20 active:scale-95 transition">
                        <span class="material-symbols-rounded text-base">add</span> Add
                    </button>
                </div>
                <p class="text-xs text-gray-400 font-medium">Items you buy every week regardless of recipes. Toggle them on to add to your shopping list.</p>
            </div>
            <div class="flex-1 px-4 py-4 lg:px-6 overflow-y-auto">
                <div id="pantryList"></div>
            </div>
        </div>

        <!-- ============= SETTINGS PAGE ============= -->
        <div id="page-settings" class="page flex-1">
            <div class="sticky top-0 bg-white/95 backdrop-blur-lg z-30 border-b border-gray-100 px-4 pt-4 pb-3 lg:px-6">
                <h2 class="text-xl font-black tracking-tight">Settings</h2>
            </div>
            <div class="flex-1 px-4 py-4 lg:px-6 overflow-y-auto">
                <div class="max-w-md mx-auto space-y-6">
                    <!-- Cloud Sync -->
                    <div class="card p-5">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center">
                                <span class="material-symbols-rounded text-blue-500">cloud_sync</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-sm">Cloud Sync</h3>
                                <p class="text-[11px] text-gray-400">Sync data across devices via JSONBin</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <input id="cloudKey" type="password" placeholder="JSONBin Master Key" onchange="cloudConfig.key=this.value; sync();" class="input text-xs">
                            <input id="cloudBin" type="text" placeholder="Bin ID" onchange="cloudConfig.bin=this.value; sync();" class="input text-xs">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="pushBtn" onclick="pushToCloud()" class="bg-gray-900 text-white p-3 rounded-xl font-bold text-[11px] active:scale-95 transition">Push</button>
                                <button onclick="pullFromCloud()" class="bg-brand-500 text-white p-3 rounded-xl font-bold text-[11px] active:scale-95 transition">Pull</button>
                            </div>
                        </div>
                    </div>
                    <!-- About -->
                    <div class="card p-5">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-brand-50 flex items-center justify-center">
                                <span class="material-symbols-rounded text-brand-500">info</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-sm">Kitchen Master</h3>
                                <p class="text-[11px] text-gray-400">Version 0.1 &middot; Meal Planning Made Easy</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Mobile Bottom Nav -->
    <nav class="mobile-nav fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-lg border-t border-gray-100 z-50 lg:hidden">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto px-2">
            <button onclick="switchPage('recipes')" class="nav-item active flex flex-col items-center justify-center flex-1 py-1" data-page="recipes">
                <span class="nav-icon material-symbols-rounded text-xl text-gray-400">menu_book</span>
                <span class="nav-label text-[10px] font-semibold text-gray-400 mt-0.5">Recipes</span>
            </button>
            <button onclick="switchPage('shopping')" class="nav-item flex flex-col items-center justify-center flex-1 py-1" data-page="shopping">
                <span class="nav-icon material-symbols-rounded text-xl text-gray-400">shopping_cart</span>
                <span class="nav-label text-[10px] font-semibold text-gray-400 mt-0.5">Shop</span>
            </button>
            <button onclick="switchPage('pantry')" class="nav-item flex flex-col items-center justify-center flex-1 py-1" data-page="pantry">
                <span class="nav-icon material-symbols-rounded text-xl text-gray-400">kitchen</span>
                <span class="nav-label text-[10px] font-semibold text-gray-400 mt-0.5">Pantry</span>
            </button>
            <button onclick="switchPage('settings')" class="nav-item flex flex-col items-center justify-center flex-1 py-1" data-page="settings">
                <span class="nav-icon material-symbols-rounded text-xl text-gray-400">settings</span>
                <span class="nav-label text-[10px] font-semibold text-gray-400 mt-0.5">Settings</span>
            </button>
        </div>
    </nav>
</div>

<!-- ============= SHEET: Add/Edit Recipe ============= -->
<div id="recipeSheet" class="sheet-overlay" onclick="closeSheet('recipeSheet')">
    <div class="sheet" onclick="event.stopPropagation()">
        <div class="sticky top-0 bg-white z-10 px-5 pt-5 pb-3 border-b border-gray-100 flex items-center justify-between">
            <h3 class="font-black text-lg" id="recipeSheetTitle">New Recipe</h3>
            <button onclick="closeSheet('recipeSheet')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                <span class="material-symbols-rounded text-sm">close</span>
            </button>
        </div>
        <div class="p-5 space-y-4">
            <input id="mealName" type="text" placeholder="Recipe name" class="input text-base">
            <div>
                <label class="text-[11px] font-bold text-gray-400 uppercase tracking-wide mb-2 block">Ingredients</label>
                <div id="ingInputs" class="space-y-2"></div>
                <button onclick="addNewLine()" class="flex items-center gap-1 mt-3 text-brand-600 font-bold text-xs active:scale-95 transition">
                    <span class="material-symbols-rounded text-base">add_circle</span> Add Ingredient
                </button>
            </div>
            <div>
                <label class="text-[11px] font-bold text-gray-400 uppercase tracking-wide mb-2 block">Instructions <span class="text-gray-300">(optional)</span></label>
                <div id="stepsInputs" class="space-y-2"></div>
                <button onclick="addStepLine()" class="flex items-center gap-1 mt-3 text-brand-600 font-bold text-xs active:scale-95 transition">
                    <span class="material-symbols-rounded text-base">add_circle</span> Add Step
                </button>
            </div>
        </div>
        <div class="sticky bottom-0 bg-white border-t border-gray-100 p-5">
            <button onclick="processSave()" class="w-full bg-brand-500 text-white py-4 rounded-2xl font-black text-sm shadow-lg shadow-brand-500/20 active:scale-95 transition">Save Recipe</button>
        </div>
    </div>
</div>

<!-- ============= SHEET: Recipe Detail / Cooking Mode ============= -->
<div id="cookSheet" class="sheet-overlay" onclick="closeSheet('cookSheet')">
    <div class="sheet" onclick="event.stopPropagation()">
        <div class="sticky top-0 bg-white z-10 px-5 pt-5 pb-3 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <h3 class="font-black text-lg" id="cookTitle">Recipe</h3>
                <button onclick="closeSheet('cookSheet')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                    <span class="material-symbols-rounded text-sm">close</span>
                </button>
            </div>
        </div>
        <div class="p-5" id="cookContent"></div>
    </div>
</div>

<!-- ============= SHEET: Shop Actions ============= -->
<div id="shopActionsSheet" class="sheet-overlay" onclick="closeSheet('shopActionsSheet')">
    <div class="sheet" onclick="event.stopPropagation()" style="max-width:400px">
        <div class="p-5 space-y-2">
            <h3 class="font-black text-base mb-3">Shopping List Actions</h3>
            <button onclick="clearCheckedItems(); closeSheet('shopActionsSheet');" class="w-full flex items-center gap-3 p-4 rounded-xl bg-gray-50 hover:bg-gray-100 active:scale-98 transition text-left">
                <span class="material-symbols-rounded text-amber-500">playlist_remove</span>
                <div>
                    <div class="font-bold text-sm">Clear Checked Items</div>
                    <div class="text-[11px] text-gray-400">Remove checked items from the list</div>
                </div>
            </button>
            <button onclick="resetShoppingList(); closeSheet('shopActionsSheet');" class="w-full flex items-center gap-3 p-4 rounded-xl bg-gray-50 hover:bg-gray-100 active:scale-98 transition text-left">
                <span class="material-symbols-rounded text-blue-500">restart_alt</span>
                <div>
                    <div class="font-bold text-sm">Reset List</div>
                    <div class="text-[11px] text-gray-400">Deselect all recipes &amp; clear checks</div>
                </div>
            </button>
            <button onclick="closeSheet('shopActionsSheet')" class="w-full p-3 rounded-xl text-center text-sm font-bold text-gray-400 mt-2">Cancel</button>
        </div>
    </div>
</div>

<!-- ============= SHEET: Add Pantry Staple ============= -->
<div id="stapleSheet" class="sheet-overlay" onclick="closeSheet('stapleSheet')">
    <div class="sheet" onclick="event.stopPropagation()" style="max-width:400px">
        <div class="sticky top-0 bg-white z-10 px-5 pt-5 pb-3 border-b border-gray-100 flex items-center justify-between">
            <h3 class="font-black text-lg">Add Pantry Staple</h3>
            <button onclick="closeSheet('stapleSheet')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                <span class="material-symbols-rounded text-sm">close</span>
            </button>
        </div>
        <div class="p-5 space-y-3">
            <input id="stapleName" type="text" placeholder="Item name (e.g. Milk)" class="input">
            <div class="grid grid-cols-2 gap-3">
                <input id="stapleQty" type="number" step="any" placeholder="Qty" value="1" class="input">
                <select id="stapleCat" class="input">
                    <option value="Produce">ü•¶ Produce</option>
                    <option value="Meat">ü•© Meat</option>
                    <option value="Dairy" selected>üßÄ Dairy</option>
                    <option value="Pantry">ü•´ Pantry</option>
                    <option value="Frozen">üßä Frozen</option>
                    <option value="Bakery">üçû Bakery</option>
                    <option value="General">üì¶ General</option>
                </select>
            </div>
            <button onclick="saveStaple()" class="w-full bg-brand-500 text-white py-4 rounded-2xl font-black text-sm shadow-lg shadow-brand-500/20 active:scale-95 transition mt-2">Add Staple</button>
        </div>
    </div>
</div>

<script>
// ==================== STATE ====================
const STORAGE_KEY = 'KITCHEN_MASTER_V4.2';
let recipes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let inventory = JSON.parse(localStorage.getItem(STORAGE_KEY + '_INV')) || [];
let memory = JSON.parse(localStorage.getItem(STORAGE_KEY + '_MEM')) || {};
let cloudConfig = JSON.parse(localStorage.getItem(STORAGE_KEY + '_CLOUD')) || { key: '', bin: '' };
let pantryStaples = JSON.parse(localStorage.getItem(STORAGE_KEY + '_PANTRY')) || [];

let editingId = null;
let isStoreMode = false;
let sortMode = 'aisle';
let currentPage = 'recipes';
let cookingStep = 0;

const catIcons = { "Produce": "ü•¶", "Meat": "ü•©", "Dairy": "üßÄ", "Pantry": "ü•´", "Frozen": "üßä", "Bakery": "üçû", "General": "üì¶" };

// ==================== SYNC ====================
function sync() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(recipes));
    localStorage.setItem(STORAGE_KEY + '_INV', JSON.stringify(inventory));
    localStorage.setItem(STORAGE_KEY + '_MEM', JSON.stringify(memory));
    localStorage.setItem(STORAGE_KEY + '_CLOUD', JSON.stringify(cloudConfig));
    localStorage.setItem(STORAGE_KEY + '_PANTRY', JSON.stringify(pantryStaples));
    renderAll();
}

// ==================== CLOUD ====================
async function pushToCloud() {
    if (!cloudConfig.key || !cloudConfig.bin) return alert("Set up your Cloud Key and Bin ID in Settings first.");
    const btn = document.getElementById('pushBtn');
    btn.innerText = "Pushing...";
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${cloudConfig.bin}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': cloudConfig.key },
            body: JSON.stringify({ recipes, inventory, memory, pantryStaples })
        });
        if (res.ok) showToast("Synced to cloud");
    } catch (e) { showToast("Sync failed", true); }
    btn.innerText = "Push";
}

async function pullFromCloud() {
    if (!cloudConfig.key || !cloudConfig.bin) return showToast("Set up Cloud Sync in Settings first", true);
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.querySelector('.material-symbols-rounded').classList.add('animate-spin');
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${cloudConfig.bin}/latest`, { headers: { 'X-Master-Key': cloudConfig.key } });
        const data = await res.json();
        if (data.record) {
            recipes = data.record.recipes || [];
            inventory = data.record.inventory || [];
            memory = data.record.memory || {};
            pantryStaples = data.record.pantryStaples || pantryStaples;
            sync();
            showToast("List refreshed from cloud");
        }
    } catch (e) { showToast("Could not refresh", true); }
    refreshBtn.querySelector('.material-symbols-rounded').classList.remove('animate-spin');
}

// ==================== TOAST ====================
function showToast(msg, isError = false) {
    const toast = document.createElement('div');
    toast.className = `fixed top-5 left-1/2 -translate-x-1/2 z-[200] px-5 py-3 rounded-2xl font-bold text-sm shadow-xl transition-all ${isError ? 'bg-red-500 text-white' : 'bg-gray-900 text-white'}`;
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2200);
}

// ==================== NAVIGATION ====================
function switchPage(page) {
    currentPage = page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    // Mobile nav highlight
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll(`.nav-item[data-page="${page}"]`).forEach(n => n.classList.add('active'));
    // Desktop nav highlight
    document.querySelectorAll('.desk-nav').forEach(n => {
        n.classList.remove('bg-brand-50', 'text-brand-700');
        n.classList.add('text-gray-500');
    });
    document.querySelectorAll(`.desk-nav[data-page="${page}"]`).forEach(n => {
        n.classList.add('bg-brand-50', 'text-brand-700');
        n.classList.remove('text-gray-500');
    });
    renderAll();
}

// ==================== SHEETS ====================
function openSheet(id) { document.getElementById(id).classList.add('open'); }
function closeSheet(id) { document.getElementById(id).classList.remove('open'); }

// ==================== RENDER ====================
function renderAll() {
    renderRecipes();
    renderShopping();
    renderPantry();
}

function renderRecipes() {
    const search = (document.getElementById('searchBar')?.value || '').toLowerCase();
    const menuDiv = document.getElementById('menuList');
    const filtered = recipes.filter(r => r.name.toLowerCase().includes(search));

    if (!filtered.length) {
        menuDiv.innerHTML = `<div class="text-center py-16">
            <span class="material-symbols-rounded text-5xl text-gray-200 block mb-3">menu_book</span>
            <p class="text-sm text-gray-400 font-medium">${recipes.length ? 'No recipes match your search' : 'No recipes yet. Tap + New to add one!'}</p>
        </div>`;
        return;
    }

    menuDiv.innerHTML = filtered.map(r => {
        const hasSteps = r.steps && r.steps.length > 0;
        return `<div class="card mb-3 p-4 cursor-pointer ${r.selected ? 'card-selected' : ''}" onclick="toggleMeal(${r.id})">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <div class="w-10 h-10 rounded-xl ${r.selected ? 'bg-brand-500' : 'bg-gray-100'} flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-rounded ${r.selected ? 'text-white' : 'text-gray-400'} text-lg">${r.selected ? 'check' : 'restaurant'}</span>
                    </div>
                    <div class="min-w-0">
                        <p class="font-bold text-sm truncate">${r.name}</p>
                        <p class="text-[11px] ${r.selected ? 'text-gray-400' : 'text-gray-400'} font-medium">${r.list.length} ingredient${r.list.length !== 1 ? 's' : ''}${hasSteps ? ' &middot; ' + r.steps.length + ' step' + (r.steps.length !== 1 ? 's' : '') : ''}</p>
                    </div>
                </div>
                <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                    ${hasSteps ? `<button onclick="openCookMode(${r.id}, event)" class="w-9 h-9 rounded-xl ${r.selected ? 'hover:bg-white/10' : 'hover:bg-gray-100'} flex items-center justify-center transition" title="Cooking Mode"><span class="material-symbols-rounded text-lg ${r.selected ? 'text-brand-400' : 'text-brand-500'}">skillet</span></button>` : ''}
                    <button onclick="editRecipe(${r.id}, event)" class="w-9 h-9 rounded-xl ${r.selected ? 'hover:bg-white/10' : 'hover:bg-gray-100'} flex items-center justify-center transition"><span class="material-symbols-rounded text-lg ${r.selected ? 'text-gray-400' : 'text-gray-400'}">edit</span></button>
                    <button onclick="deleteMeal(${r.id}, event)" class="w-9 h-9 rounded-xl ${r.selected ? 'hover:bg-red-500/20' : 'hover:bg-red-50'} flex items-center justify-center transition"><span class="material-symbols-rounded text-lg text-red-400">delete</span></button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function renderShopping() {
    const shopDiv = document.getElementById('shoppingItems');
    const selected = recipes.filter(r => r.selected);
    const activeStaples = pantryStaples.filter(s => s.active);
    const shopContainer = document.getElementById('shopContent');

    if (isStoreMode) shopContainer.classList.add('store-mode');
    else shopContainer.classList.remove('store-mode');

    // Update store mode button appearance
    const storeBtn = document.getElementById('storeModeBtn');
    if (isStoreMode) {
        storeBtn.classList.add('bg-brand-500');
        storeBtn.classList.remove('bg-gray-900');
    } else {
        storeBtn.classList.remove('bg-brand-500');
        storeBtn.classList.add('bg-gray-900');
    }

    // Show/hide finish shopping FAB
    document.getElementById('finishShoppingFab').classList.toggle('hidden', !isStoreMode);

    if (!selected.length && !activeStaples.length) {
        shopDiv.innerHTML = `<div class="text-center py-16">
            <span class="material-symbols-rounded text-5xl text-gray-200 block mb-3">shopping_cart</span>
            <p class="text-sm text-gray-400 font-medium">Select recipes to build your list</p>
        </div>`;
        return;
    }

    let html = "";

    // Pantry staples section
    if (activeStaples.length) {
        if (sortMode === 'aisle') {
            // Merge staples into aisle view below
        } else {
            html += `<div class="mb-2"><div class="flex items-center gap-2 mt-4 mb-3 pl-1"><span class="material-symbols-rounded text-sm text-amber-500">star</span><span class="text-[11px] font-black uppercase text-amber-600 tracking-widest">Pantry Staples</span></div>`;
            activeStaples.forEach(s => html += renderShopItem(s));
            html += `</div>`;
        }
    }

    if (sortMode === 'aisle') {
        const totals = {};
        selected.forEach(r => r.list.forEach(i => {
            const key = `${i.name}|${i.category}`;
            if (!totals[key]) totals[key] = { ...i }; else totals[key].qty += i.qty;
        }));
        // Merge active pantry staples into aisle view
        activeStaples.forEach(s => {
            const key = `${s.name}|${s.category}`;
            if (!totals[key]) totals[key] = { ...s }; else totals[key].qty += s.qty;
        });
        const grouped = Object.values(totals).reduce((a, c) => { (a[c.category] = a[c.category] || []).push(c); return a; }, {});
        const sortedCats = Object.keys(grouped).sort();
        sortedCats.forEach(cat => {
            html += `<div class="mb-2"><div class="flex items-center gap-2 mt-4 mb-3 pl-1"><span class="text-sm">${catIcons[cat] || 'üì¶'}</span><span class="text-[11px] font-black uppercase text-gray-400 tracking-widest">${cat}</span><span class="pill bg-gray-100 text-gray-400 ml-auto">${grouped[cat].length}</span></div>`;
            grouped[cat].forEach(i => html += renderShopItem(i));
            html += `</div>`;
        });
    } else {
        selected.forEach(r => {
            html += `<div class="mb-2"><div class="flex items-center gap-2 mt-4 mb-3 pl-1"><span class="material-symbols-rounded text-sm text-brand-500">restaurant</span><span class="text-[11px] font-black uppercase text-brand-600 tracking-widest">${r.name}</span><span class="pill bg-brand-50 text-brand-600 ml-auto">${r.list.length}</span></div>`;
            r.list.forEach(i => html += renderShopItem(i));
            html += `</div>`;
        });
    }
    shopDiv.innerHTML = html;
}

function renderShopItem(i) {
    const has = inventory.includes(i.name.toLowerCase());
    const escapedName = i.name.toLowerCase().replace(/'/g, "\\'");
    return `<div onclick="toggleInv('${escapedName}')" class="shop-item check-item flex items-center justify-between p-3.5 bg-white border border-gray-100 rounded-xl mb-2 cursor-pointer ${has ? 'checked' : ''} shadow-sm">
        <div class="flex items-center gap-3">
            <input type="checkbox" ${has ? 'checked' : ''} class="w-5 h-5 rounded-lg pointer-events-none flex-shrink-0">
            <span class="item-name font-semibold text-sm capitalize">${i.name}</span>
        </div>
        <span class="item-qty bg-gray-900 text-white px-2.5 py-1 rounded-lg text-[10px] font-bold flex-shrink-0">${i.qty} ${i.unit || 'pcs'}</span>
    </div>`;
}

function renderPantry() {
    const listDiv = document.getElementById('pantryList');
    if (!pantryStaples.length) {
        listDiv.innerHTML = `<div class="text-center py-16">
            <span class="material-symbols-rounded text-5xl text-gray-200 block mb-3">kitchen</span>
            <p class="text-sm text-gray-400 font-medium">No staples yet. Add items you buy every week.</p>
        </div>`;
        return;
    }
    listDiv.innerHTML = pantryStaples.map((s, idx) => `
        <div class="card mb-3 p-4 flex items-center justify-between">
            <div class="flex items-center gap-3 flex-1 min-w-0">
                <button onclick="toggleStaple(${idx})" class="w-10 h-10 rounded-xl ${s.active ? 'bg-brand-500' : 'bg-gray-100'} flex items-center justify-center flex-shrink-0 active:scale-90 transition">
                    <span class="material-symbols-rounded ${s.active ? 'text-white' : 'text-gray-400'} text-lg">${s.active ? 'check' : 'close'}</span>
                </button>
                <div class="min-w-0">
                    <p class="font-bold text-sm capitalize truncate">${s.name}</p>
                    <p class="text-[11px] text-gray-400 font-medium">${catIcons[s.category] || 'üì¶'} ${s.category} &middot; ${s.qty} ${s.unit || 'pcs'}</p>
                </div>
            </div>
            <button onclick="deleteStaple(${idx})" class="w-9 h-9 rounded-xl hover:bg-red-50 flex items-center justify-center transition flex-shrink-0">
                <span class="material-symbols-rounded text-lg text-red-400">delete</span>
            </button>
        </div>
    `).join('');
}

// ==================== RECIPES ====================
function toggleMeal(id) { const r = recipes.find(x => x.id === id); r.selected = !r.selected; sync(); }
function toggleInv(n) { if (inventory.includes(n)) inventory = inventory.filter(x => x !== n); else inventory.push(n); sync(); }
function deleteMeal(id, e) { e.stopPropagation(); if (confirm("Delete this recipe?")) { recipes = recipes.filter(x => x.id !== id); sync(); } }

function openAddRecipe() {
    editingId = null;
    document.getElementById('mealName').value = '';
    document.getElementById('ingInputs').innerHTML = '';
    document.getElementById('stepsInputs').innerHTML = '';
    document.getElementById('recipeSheetTitle').textContent = 'New Recipe';
    addNewLine();
    openSheet('recipeSheet');
}

function addNewLine(n = "", q = "", u = "pcs", c = "General") {
    const container = document.getElementById('ingInputs');
    const div = document.createElement('div');
    div.className = "flex gap-2 p-2.5 bg-gray-50 rounded-xl items-center";
    div.innerHTML = `
        <input type="text" placeholder="Item" value="${n}" class="i-val flex-1 bg-transparent text-sm font-semibold outline-none min-w-0">
        <input type="number" step="any" value="${q}" placeholder="#" class="q-val w-14 text-center font-bold bg-white rounded-lg p-1.5 border border-gray-100 text-sm">
        <select class="c-val text-[11px] font-bold bg-white rounded-lg p-1.5 border border-gray-100">${Object.keys(catIcons).map(k => `<option value="${k}" ${c === k ? 'selected' : ''}>${catIcons[k]} ${k}</option>`).join('')}</select>
        <button onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-400 transition flex-shrink-0"><span class="material-symbols-rounded text-lg">close</span></button>`;
    container.appendChild(div);
}

function addStepLine(text = "") {
    const container = document.getElementById('stepsInputs');
    const idx = container.children.length + 1;
    const div = document.createElement('div');
    div.className = "flex gap-2 items-start";
    div.innerHTML = `
        <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-700 flex items-center justify-center text-xs font-black flex-shrink-0 mt-2">${idx}</span>
        <textarea placeholder="Describe this step..." class="step-val flex-1 bg-gray-50 rounded-xl p-3 text-sm font-medium outline-none border-2 border-transparent focus:border-brand-500 resize-none" rows="2">${text}</textarea>
        <button onclick="this.parentElement.remove(); renumberSteps();" class="text-gray-300 hover:text-red-400 transition flex-shrink-0 mt-2"><span class="material-symbols-rounded text-lg">close</span></button>`;
    container.appendChild(div);
}

function renumberSteps() {
    document.querySelectorAll('#stepsInputs > div').forEach((div, i) => {
        div.querySelector('span').textContent = i + 1;
    });
}

function processSave() {
    const name = document.getElementById('mealName').value.trim();
    if (!name) return showToast("Enter a recipe name", true);
    let list = [];
    document.querySelectorAll('#ingInputs > div').forEach(r => {
        const item = r.querySelector('.i-val').value.trim();
        if (item) list.push({ name: item.toLowerCase(), qty: parseFloat(r.querySelector('.q-val').value) || 0, unit: 'pcs', category: r.querySelector('.c-val').value });
    });
    let steps = [];
    document.querySelectorAll('#stepsInputs > div').forEach(r => {
        const text = r.querySelector('.step-val').value.trim();
        if (text) steps.push(text);
    });

    const wasEditing = !!editingId;
    if (editingId) {
        const idx = recipes.findIndex(r => r.id === editingId);
        recipes[idx] = { ...recipes[idx], name, list, steps };
    } else {
        recipes.push({ id: Date.now(), name, list, steps, selected: false });
    }
    editingId = null;
    closeSheet('recipeSheet');
    sync();
    showToast(wasEditing ? "Recipe updated" : "Recipe saved");
}

function editRecipe(id, e) {
    e.stopPropagation();
    const r = recipes.find(x => x.id === id);
    editingId = id;
    document.getElementById('mealName').value = r.name;
    document.getElementById('ingInputs').innerHTML = '';
    document.getElementById('stepsInputs').innerHTML = '';
    document.getElementById('recipeSheetTitle').textContent = 'Edit Recipe';
    r.list.forEach(i => addNewLine(i.name, i.qty, i.unit, i.category));
    if (r.steps && r.steps.length) r.steps.forEach(s => addStepLine(s));
    openSheet('recipeSheet');
}

// ==================== COOKING MODE ====================
function openCookMode(id, e) {
    e.stopPropagation();
    const r = recipes.find(x => x.id === id);
    if (!r || !r.steps || !r.steps.length) return;
    cookingStep = 0;
    document.getElementById('cookTitle').textContent = r.name;
    renderCookContent(r);
    openSheet('cookSheet');
}

function renderCookContent(r) {
    let html = '';
    // Ingredients summary
    html += `<div class="mb-6"><h4 class="text-[11px] font-black uppercase text-gray-400 tracking-widest mb-3">Ingredients</h4><div class="grid grid-cols-2 gap-2">`;
    r.list.forEach(i => {
        html += `<div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg"><span class="text-sm">${catIcons[i.category] || 'üì¶'}</span><span class="text-sm font-medium capitalize">${i.name}</span><span class="text-[10px] font-bold text-gray-400 ml-auto">${i.qty} ${i.unit || 'pcs'}</span></div>`;
    });
    html += `</div></div>`;

    // Steps
    html += `<h4 class="text-[11px] font-black uppercase text-gray-400 tracking-widest mb-3">Steps</h4>`;
    r.steps.forEach((step, idx) => {
        html += `<div class="cook-step ${idx === cookingStep ? 'active-step' : ''}" onclick="setCookStep(${r.id}, ${idx})">
            <div class="flex items-start gap-3">
                <span class="w-8 h-8 rounded-full ${idx === cookingStep ? 'bg-brand-500 text-white' : 'bg-gray-200 text-gray-500'} flex items-center justify-center text-sm font-black flex-shrink-0">${idx + 1}</span>
                <p class="flex-1 pt-1">${step}</p>
            </div>
        </div>`;
    });

    // Navigation buttons
    html += `<div class="flex gap-3 mt-4">`;
    if (cookingStep > 0) html += `<button onclick="navCookStep(${r.id}, -1)" class="flex-1 py-3 rounded-xl bg-gray-100 font-bold text-sm active:scale-95 transition">Previous</button>`;
    if (cookingStep < r.steps.length - 1) html += `<button onclick="navCookStep(${r.id}, 1)" class="flex-1 py-3 rounded-xl bg-brand-500 text-white font-bold text-sm active:scale-95 transition shadow-lg shadow-brand-500/20">Next Step</button>`;
    else html += `<button onclick="closeSheet('cookSheet')" class="flex-1 py-3 rounded-xl bg-brand-500 text-white font-bold text-sm active:scale-95 transition shadow-lg shadow-brand-500/20">Done Cooking!</button>`;
    html += `</div>`;

    document.getElementById('cookContent').innerHTML = html;
}

function setCookStep(id, step) {
    const r = recipes.find(x => x.id === id);
    cookingStep = step;
    renderCookContent(r);
}

function navCookStep(id, dir) {
    const r = recipes.find(x => x.id === id);
    cookingStep = Math.max(0, Math.min(r.steps.length - 1, cookingStep + dir));
    renderCookContent(r);
    // Scroll active step into view
    setTimeout(() => {
        const activeStep = document.querySelector('.active-step');
        if (activeStep) activeStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 50);
}

// ==================== SHOPPING ACTIONS ====================
function toggleStoreMode() {
    isStoreMode = !isStoreMode;
    renderShopping();
}

function openShopActions() {
    openSheet('shopActionsSheet');
}

function clearCheckedItems() {
    const checkedNames = [...inventory];
    if (!checkedNames.length) return showToast("No checked items to clear");
    // Remove checked items from all selected recipes
    recipes.forEach(r => {
        if (r.selected) {
            r.list = r.list.filter(i => !checkedNames.includes(i.name.toLowerCase()));
        }
    });
    inventory = [];
    sync();
    showToast("Checked items cleared");
}

function resetShoppingList() {
    if (!confirm("Reset the shopping list? This will deselect all recipes and clear all checks.")) return;
    recipes.forEach(r => r.selected = false);
    inventory = [];
    sync();
    showToast("Shopping list reset");
}

function finishShopping() {
    const checkedCount = inventory.length;
    if (!checkedCount) return showToast("Check off items you've found first");
    if (!confirm(`Finish shopping? ${checkedCount} found item(s) will be removed. Unchecked items will stay on your list.`)) return;
    // Remove checked items from selected recipes
    recipes.forEach(r => {
        if (r.selected) {
            r.list = r.list.filter(i => !inventory.includes(i.name.toLowerCase()));
        }
    });
    // Also uncheck staples that were checked
    pantryStaples.forEach(s => {
        if (inventory.includes(s.name.toLowerCase())) {
            s.active = false;
        }
    });
    inventory = [];
    isStoreMode = false;
    sync();
    showToast("Shopping complete! Unfound items remain on your list.");
}

function setSortMode(mode) {
    sortMode = mode;
    document.getElementById('sortAisleBtn').classList.toggle('active', mode === 'aisle');
    document.getElementById('sortRecipeBtn').classList.toggle('active', mode === 'recipe');
    renderShopping();
}

// ==================== PANTRY STAPLES ====================
function openAddStaple() {
    document.getElementById('stapleName').value = '';
    document.getElementById('stapleQty').value = '1';
    openSheet('stapleSheet');
}

function saveStaple() {
    const name = document.getElementById('stapleName').value.trim();
    if (!name) return showToast("Enter an item name", true);
    const qty = parseFloat(document.getElementById('stapleQty').value) || 1;
    const category = document.getElementById('stapleCat').value;
    pantryStaples.push({ name: name.toLowerCase(), qty, unit: 'pcs', category, active: true });
    closeSheet('stapleSheet');
    sync();
    showToast("Staple added");
}

function toggleStaple(idx) {
    pantryStaples[idx].active = !pantryStaples[idx].active;
    sync();
}

function deleteStaple(idx) {
    if (confirm("Remove this pantry staple?")) {
        pantryStaples.splice(idx, 1);
        sync();
    }
}

// ==================== INIT ====================
window.onload = () => {
    document.getElementById('cloudKey').value = cloudConfig.key;
    document.getElementById('cloudBin').value = cloudConfig.bin;
    renderAll();
    switchPage('recipes');
}
</script>
</body>
</html>

