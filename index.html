<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kitchen Master - Cloud v4.5</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: { brand: { 50: '#f0fdf9', 100: '#ccfbef', 200: '#99f6df', 300: '#5ceac8', 400: '#2dd4ab', 500: '#14b893', 600: '#0d9477', 700: '#0f7661', 800: '#115e4f', 900: '#134d42' } }
                }
            }
        }
    </script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { background-color: #f8fafc !important; color: #0f172a !important; font-family: 'Inter', sans-serif; overscroll-behavior-y: contain; }
        .gradient-text { background: linear-gradient(135deg, #14b893, #0d9477); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(16px); z-index: 9999; justify-content: center; align-items: flex-end; }
        @media (min-width: 640px) { .modal-overlay { align-items: center; } }
        .modal-content { background: #ffffff !important; width: 100%; max-width: 800px; border-radius: 1.5rem 1.5rem 0 0; padding: 1.5rem; animation: slideUp 0.3s ease; }
        @media (min-width: 640px) { .modal-content { border-radius: 1.5rem; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .recipe-card-ui { border: 1px solid #e2e8f0; transition: all 0.2s; background: white; cursor: pointer; }
        .recipe-selected { background: #0f172a !important; color: white !important; border-color: #14b893 !important; }
        .is-store-mode .store-hide { display: none !important; }
        .is-store-mode .lg-col-span-3 { grid-column: span 5 / span 5; }
        #syncIndicator.syncing { color: #14b893; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
    <script>
        const STORAGE_KEY = 'KITCHEN_MASTER_V4.5';
        let recipes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let inventory = JSON.parse(localStorage.getItem(STORAGE_KEY + '_INV')) || [];
        let memory = JSON.parse(localStorage.getItem(STORAGE_KEY + '_MEM')) || {};
        let cloudConfig = JSON.parse(localStorage.getItem(STORAGE_KEY + '_CLOUD')) || { key: '', bin: '' };

        let editingId = null;
        let isStoreMode = false;
        const catIcons = { "Produce": "ü•¶", "Meat": "ü•©", "Dairy": "üßÄ", "Pantry": "ü•´", "Frozen": "üßä", "Bakery": "üçû", "General": "üì¶" };

        function sync(skipCloud = false) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(recipes));
            localStorage.setItem(STORAGE_KEY + '_INV', JSON.stringify(inventory));
            localStorage.setItem(STORAGE_KEY + '_MEM', JSON.stringify(memory));
            localStorage.setItem(STORAGE_KEY + '_CLOUD', JSON.stringify(cloudConfig));
            render();
            if (!skipCloud) autoPush();
        }

        async function autoPush() {
            if (!cloudConfig.key || !cloudConfig.bin) return;
            const indicator = document.getElementById('syncIndicator');
            indicator.classList.add('syncing');
            indicator.innerText = "Saving to Cloud...";
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${cloudConfig.bin}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': cloudConfig.key },
                    body: JSON.stringify({ recipes, inventory, memory })
                });
                indicator.innerText = "Cloud Synced";
                setTimeout(() => { if(indicator.innerText === "Cloud Synced") indicator.innerText = ""; }, 2000);
            } catch (e) { indicator.innerText = "Sync Error"; }
            indicator.classList.remove('syncing');
        }

        async function pullFromCloud(isAuto = false) {
            if (!cloudConfig.key || !cloudConfig.bin) return;
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${cloudConfig.bin}/latest`, { headers: { 'X-Master-Key': cloudConfig.key } });
                const data = await res.json();
                if (data.record) {
                    recipes = data.record.recipes || [];
                    inventory = data.record.inventory || [];
                    memory = data.record.memory || {};
                    sync(true); // Don't push what we just pulled
                    if(!isAuto) alert("Data Refreshed!");
                }
            } catch (e) { console.error("Pull failed"); }
        }

        function render() {
            const search = document.getElementById('searchBar').value.toLowerCase();
            const menuDiv = document.getElementById('menuList');
            menuDiv.innerHTML = recipes.filter(r => r.name.toLowerCase().includes(search)).map(r => `
                <div onclick="toggleMeal(${r.id})" class="p-4 mb-2 rounded-xl recipe-card-ui ${r.selected?'recipe-selected':''}">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-sm">${r.name}</span>
                        <div class="flex gap-2">
                            <button onclick="editRecipe(${r.id}, event)" class="p-1 opacity-50 hover:opacity-100">‚úèÔ∏è</button>
                            <button onclick="deleteMeal(${r.id}, event)" class="p-1 text-red-400">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>`).join('');

            const shopDiv = document.getElementById('shoppingItems');
            const selected = recipes.filter(r => r.selected);
            if (!selected.length) {
                shopDiv.innerHTML = `<div class="text-center py-20 opacity-20 font-black">SELECT A RECIPE</div>`;
                return;
            }

            const totals = {};
            selected.forEach(r => r.list.forEach(i => {
                const key = `${i.name}|${i.category}`;
                if (!totals[key]) totals[key] = { ...i }; else totals[key].qty += i.qty;
            }));

            const grouped = Object.values(totals).reduce((a, c) => { (a[c.category] = a[c.category] || []).push(c); return a; }, {});
            let html = "";
            Object.keys(grouped).sort().forEach(cat => {
                html += `<h3 class="text-[10px] font-black uppercase text-slate-400 mt-6 mb-2 tracking-widest pl-1">${catIcons[cat]||'üì¶'} ${cat}</h3>`;
                grouped[cat].forEach(i => {
                    const has = inventory.includes(i.name.toLowerCase());
                    html += `<div onclick="toggleInv('${i.name.toLowerCase()}')" class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl mb-2 ${has?'opacity-30':''} shadow-sm">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" ${has?'checked':''} class="w-5 h-5 accent-brand-500">
                            <span class="font-bold capitalize ${has?'line-through':''}">${i.name}</span>
                        </div>
                        <span class="bg-slate-100 px-2 py-1 rounded text-[10px] font-bold">${i.qty} ${i.unit}</span>
                    </div>`;
                });
            });
            shopDiv.innerHTML = html;
        }

        function toggleMeal(id) { const r = recipes.find(x => x.id === id); r.selected = !r.selected; sync(); }
        function toggleInv(n) { if(inventory.includes(n)) inventory=inventory.filter(x=>x!==n); else inventory.push(n); sync(); }
        function deleteMeal(id, e) { e.stopPropagation(); if(confirm("Delete?")) { recipes=recipes.filter(x=>x.id!==id); sync(); } }
        
        function addNewLine(n="", q="", u="pcs", c="General") {
            const container = document.getElementById('ingInputs');
            const div = document.createElement('div');
            div.className = "flex gap-2 mb-2 p-2 bg-slate-50 rounded-xl items-center";
            div.innerHTML = `
                <input type="text" placeholder="Item" value="${n}" class="i-val flex-1 bg-transparent text-sm font-bold outline-none">
                <input type="number" step="any" value="${q}" class="q-val w-12 text-center font-bold bg-white rounded-lg p-1 border">
                <select class="c-val text-[10px] font-bold bg-white rounded-lg p-1">${Object.keys(catIcons).map(k=>`<option value="${k}" ${c===k?'selected':''}>${catIcons[k]}</option>`).join('')}</select>
                <button onclick="this.parentElement.remove()" class="text-slate-300 px-2 font-black">‚úï</button>`;
            container.appendChild(div);
        }

        function processSave() {
            const name = document.getElementById('mealName').value.trim();
            if (!name) return;
            let list = [];
            document.querySelectorAll('#ingInputs > div').forEach(r => {
                const item = r.querySelector('.i-val').value.trim();
                if (item) list.push({ name: item.toLowerCase(), qty: parseFloat(r.querySelector('.q-val').value)||0, unit: 'pcs', category: r.querySelector('.c-val').value });
            });
            if (editingId) recipes[recipes.findIndex(r=>r.id===editingId)] = { ...recipes.find(r=>r.id===editingId), name, list };
            else recipes.push({ id: Date.now(), name, list, selected: false });
            document.getElementById('mealName').value = ""; document.getElementById('ingInputs').innerHTML = ""; addNewLine();
            editingId = null; sync();
        }

        function editRecipe(id, e) {
            e.stopPropagation(); const r = recipes.find(x=>x.id===id); editingId = id;
            document.getElementById('mealName').value = r.name; document.getElementById('ingInputs').innerHTML = "";
            r.list.forEach(i => addNewLine(i.name, i.qty, i.unit, i.category));
        }

        window.onload = () => {
            document.getElementById('cloudKey').value = cloudConfig.key;
            document.getElementById('cloudBin').value = cloudConfig.bin;
            render(); addNewLine();
            pullFromCloud(true); // Auto-pull on load
        }
    </script>
</head>
<body class="p-3 md:p-10">
    <div class="max-w-7xl mx-auto bg-white rounded-[2rem] shadow-2xl overflow-hidden border border-slate-100">
        <header class="p-6 border-b border-slate-50 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black tracking-tighter"><span class="gradient-text">KITCHEN</span> MASTER</h1>
                <div id="syncIndicator" class="text-[9px] font-bold uppercase tracking-widest text-slate-300 h-2"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="isStoreMode=!isStoreMode; document.body.classList.toggle('is-store-mode'); render();" class="bg-slate-900 text-white px-5 py-3 rounded-2xl font-bold text-[10px]">üõí STORE MODE</button>
                <button onclick="document.getElementById('settingsModal').style.display='flex'" class="bg-slate-100 p-3 rounded-2xl store-hide">‚öôÔ∏è</button>
            </div>
        </header>

        <div class="grid lg:grid-cols-5 min-h-[80vh]">
            <div class="lg:col-span-2 p-6 bg-slate-50/50 border-r border-slate-100 store-hide">
                <div class="bg-white p-6 rounded-[2rem] shadow-sm mb-6">
                    <input id="mealName" type="text" placeholder="Recipe Title" class="w-full p-4 mb-4 rounded-2xl bg-slate-50 border-none font-bold outline-none">
                    <div id="ingInputs"></div>
                    <div class="flex justify-between mt-4">
                        <button onclick="addNewLine()" class="text-brand-600 font-black text-[10px]">+ ITEM</button>
                        <button onclick="processSave()" class="bg-brand-600 text-white px-8 py-3 rounded-2xl font-black text-xs">SAVE</button>
                    </div>
                </div>
                <div id="menuList"></div>
            </div>
            <div class="lg:col-span-3 p-6">
                <input id="searchBar" onkeyup="render()" type="text" placeholder="Search..." class="w-full p-4 rounded-2xl bg-slate-50 mb-6 store-hide font-bold outline-none">
                <div id="shoppingItems" class="max-w-xl mx-auto"></div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-black mb-6">Settings</h2>
            <div class="space-y-4">
                <input id="cloudKey" type="password" placeholder="JSONBin Key" onchange="cloudConfig.key=this.value; sync(true);" class="w-full p-4 bg-slate-100 rounded-2xl font-bold outline-none">
                <input id="cloudBin" type="text" placeholder="Bin ID" onchange="cloudConfig.bin=this.value; sync(true);" class="w-full p-4 bg-slate-100 rounded-2xl font-bold outline-none">
                <button onclick="pullFromCloud()" class="w-full bg-brand-600 text-white p-4 rounded-2xl font-black text-[10px] uppercase">Force Refresh from Cloud</button>
            </div>
        </div>
    </div>
</body>
</html>
